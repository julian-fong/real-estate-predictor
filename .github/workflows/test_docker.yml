name: test_api_docker
on:
    push:
        branches:
        - main
    pull_request:
        branches:
        - main

jobs:
    test_docker_container:
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                os: [ubuntu-latest, windows-latest]
        steps:
        - name: Checkout code
          uses: actions/checkout@v2
        
        - name: Build Docker image
          run: docker build -t fast_api_app .
        
        - name: Run Docker container
          run: docker run -e REPLIERS_KEY=${{ secrets.REPLIERS_KEY }} -d -p 8000:8000 fast_api_app

        - name: Wait for container initialization then run health check
          run: |
            sleep 10
            curl -f http://localhost:8000/health || exit 1