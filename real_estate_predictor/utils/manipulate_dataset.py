import datetime as dt
import pandas as pd
from dateutil.relativedelta import relativedelta

def extract_raw_data_listings(raw_df: pd.DataFrame, inplace = True) -> pd.DataFrame:
    """Extracts relevant data from the raw dataframe.
    Parameters
    ----------
    
    df : pd.DataFrame
        Incoming raw dataframe containing listings from a specific
        period. Assumes the following columns exists
        - details
        - address
        - condominium
        - nearby
        - map
    
    Returns
    -------
    df : pd.DataFrame
        Extracted data
    
    """
    if inplace:
        df = raw_df
    else:
        df = raw_df.copy(deep = True)
    keys = ['details', 'address', 'condominium', 'nearby','map']
    
    for key in keys:
        if key not in df.columns:
            raise ValueError(f"missing key {key} in dataframe columns")
        
    details_df = pd.DataFrame.from_records(df['details'])
    address_df = pd.DataFrame.from_records(df['address'])
    condo_df = pd.DataFrame.from_records(df['condominium'])
    nearby_df = pd.DataFrame.from_records(df['nearby'])
    map_df = pd.DataFrame.from_records(df['map'])

    df['city'] = address_df['city']
    df['area'] = address_df['area']
    df['district'] = address_df['district']
    df['neighborhood'] = address_df['neighborhood']
    df['zip'] = address_df['zip']

    df['latitude'] = map_df['latitude']
    df['longitude'] = map_df['longitude']

    df['fees'] = condo_df['fees']
    df['condo_ammenities'] = condo_df['ammenities']

    df['ammenities'] = nearby_df['ammenities']

    df['numBathrooms'] = details_df['numBathrooms']
    df['numBedrooms'] = details_df['numBedrooms']
    df['style'] = details_df['style']
    df['numKitchens'] = details_df['numKitchens']
    df['numRooms'] = details_df['numRooms']
    df['numParkingSpaces'] = details_df['numParkingSpaces']
    df['sqft'] = details_df['sqft']

    df['description'] = details_df['description']
    df['extras'] = details_df['extras']
    df['propertyType'] = details_df['propertyType']
    df['numGarageSpaces'] = details_df['numGarageSpaces']
    df['numDrivewaySpaces'] = details_df['numDrivewaySpaces']


    df = df.drop(columns=['details', 'address','condominium','map','nearby'])
    df = df.map(str)
    
    return df


def manipulate_df(df, metric):
    df = df.rename_axis('key').reset_index()
    df = df.melt(id_vars = ["key"], var_name="Date",value_name="value")
    # Extract the metric from the 'key' column
    # print(df['key'].values[0])
    df['index'] = df['key'].str.split("_").str[1] +"_"+ df['key'].str.split("_").str[2] +"_"+ df['key'].str.split("_").str[3]
    df['new_index'] = df['index']+"_"+df['Date']
    df['metric'] = df['key'].str.split("_").str[0]
    metric_columns = ['key'] + [f'{agg}_{metric}_current' for agg in sorted(set(df['metric'].values))]
    df = df.drop(columns = ["key"])
    # Pivot the DataFrame
    df = df.pivot(index=['new_index'], columns=['metric'], values='value')

    # Reset the index to make 'Date' a column again
    df.reset_index(inplace=True)
    # Rename the columns for better clarity
    df.columns.name = None  # Remove the column name generated by pivot
    # df.columns = ['key',f'avg_value_{metric}', f'count_value_{metric}', f'med_value_{metric}']
    df.columns = metric_columns
    return df

def subtract_months(col, num_months = 1):
    date_str = col.split("_")[-1]
    # Convert the input date string to a datetime object
    date_obj = dt.strptime(date_str, '%Y-%m')

    # Subtract the specified number of months
    new_date_obj = date_obj - relativedelta(months=num_months)
    new_date_obj = new_date_obj.strftime('%Y-%m')
    new_date = col.replace(date_str, new_date_obj)
    # Format the result as "YYYY-MM" and return
    return new_date
